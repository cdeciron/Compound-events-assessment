{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "c902a3cb-9050-4dad-8446-596db366a059",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Basic packages\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import xarray as xr\n",
    "import rioxarray\n",
    "import os\n",
    "import re\n",
    "#Spatial data handling\n",
    "import geopandas as gpd\n",
    "import cartopy.crs as ccrs\n",
    "import regionmask\n",
    "import rasterio \n",
    "import rasterio.features\n",
    "import pyproj \n",
    "from pyproj import CRS, Transformer\n",
    "from pyproj import Proj, Transformer\n",
    "#Plotting\n",
    "import matplotlib.pyplot as plt\n",
    "import seaborn as sns"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "e17bb9f9-a6e5-4698-8bf7-4191c14ef092",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Time periods as written in file names from the CDS EURO-CORDEX data \n",
    "## i is the number of files corresponding to a period. If 1 file = 1 year thn i=30. If 1 file = 5 years, i=5\n",
    "n = 1 #usually 1 or 5, number of years contained in one file \n",
    "x = 0 #usually 0 or 4\n",
    "\n",
    "### Historical periods\n",
    "hist_period_dates = {\n",
    "    f\"{1971 + i*n}_hist\": f\"{1971 + i*n}0101-{1971 + i*n + x}12312230\"\n",
    "    for i in range(30) #6 or 30 years\n",
    "}\n",
    "\n",
    "### Mid-century periods\n",
    "mid_period_dates = {\n",
    "    f\"{i+x}_mid\": f\"{2036 + i*n}01010130-{2036 + i*n + x}12312230\"\n",
    "    for i in range(30)\n",
    "}\n",
    "\n",
    "### End-century periods\n",
    "end_period_dates = {\n",
    "    f\"{i+x}_end\": f\"{2071 + i*n}01010130-{2071 + i*n + x}12312230\"\n",
    "    for i in range(30)\n",
    "}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "6e132aa6-7cfc-45ed-acc5-709191d6bb0e",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Path to file buildup with help of variables (refer to folders structure figure)\n",
    "location = 'Volumes'\n",
    "disk = 'LaCie 1'\n",
    "folder = 'Compound_events_study_gihub'\n",
    "subfolder = 'Climate_models_data'\n",
    "gcm_rcm_folder = 'CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63' #or 'MIROC_MIROC5_CLM_CLMcom4_8_17'.. ect\n",
    "variable_folder = 'Solar'\n",
    "\n",
    "#Variables for the files name, to be adapted depending on the GCM-RCM combination you are using \n",
    "##RIP nomenclature of the GCM-RCM combination\n",
    "rNi1p1 = 'r1i1p1' #'r1i1p1' or 'r2ip1' or 'r3ip1' or 'r2ip1'\n",
    "##Version number\n",
    "v_number = 'v2' #'v1' or 'v2'; in file name\n",
    "##Temporal resolution of the data \n",
    "time_resol = '3hr' #'day' or 3hr for solar "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "55efe05b-accb-4b3f-b315-becf2af68b24",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Set up dictionnaries for folders and files names \n",
    "## Climate variables\n",
    "variables = {\n",
    "    \"solar\": {\n",
    "        \"code\": \"rsds\",       \n",
    "        \"folder\": \"Solar\"     \n",
    "    }\n",
    "}\n",
    "\n",
    "##Climate model combinations\n",
    "###Global climate models\n",
    "GCM = {\n",
    "    'CNRM': 'CNRM-CERFACS-CNRM-CM5',\n",
    "    #'MPI': 'MPI-M-MPI-ESM-LR', \n",
    "    #'MIROC': 'MIROC-MIROC5',\n",
    "    #'EcEarth': 'ICHEC-EC-EARTH',\n",
    "    #'NorESM': 'NorESM1-M'\n",
    "    #'HadGEM': 'HadGEM-2'\n",
    "    #'MPI': 'MPI-M-MPI-ESM-LR'\n",
    "}\n",
    "\n",
    "###Regional climate models\n",
    "RCM = {\n",
    "    'R_CNRM':  'CNRM-ALADIN63',\n",
    "    #'ITCP': 'ICTP-RegCM4-6',\n",
    "    #'CLM': 'CLM-CCLM-CLMcom4-8-17'\n",
    "    #'HIRHAM': 'DMI-HIRHAM5'\n",
    "    #'RCA': 'SMHI-RCA4'\n",
    "    #'REMO2015': 'GERICS-REMO2015'\n",
    "}\n",
    "\n",
    "## Dates of the time periods previously defined \n",
    "period_dates = {\n",
    "    'hist': hist_period_dates, \n",
    "    'mid': mid_period_dates, \n",
    "    'end': end_period_dates\n",
    "    \n",
    "}\n",
    "\n",
    "##Name of the time periods\n",
    "period_names = {\n",
    "    'hist': 'historical', \n",
    "    'mid': 'mid_century', \n",
    "    'end': 'end_century'\n",
    "}\n",
    "\n",
    "##Scenarios\n",
    "scenario = {\n",
    "    'hist': 'historical', \n",
    "    'RCP': 'rcp85'\n",
    "}\n",
    "\n",
    "periods_intervalls = {\n",
    "    \"historical\": (\"1971-01-01\", \"2000-12-31\"),\n",
    "    \"near_future\": (\"2021-01-01\", \"2050-12-31\"),\n",
    "    \"far_future\": (\"2071-01-01\", \"2100-12-31\")\n",
    "}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "2da31dcf-1cf2-4e0e-a9e1-685239d4a63a",
   "metadata": {},
   "outputs": [],
   "source": [
    "def generate_file_paths(var_key):\n",
    "    files = {'hist': [], 'mid': [], 'end': []}\n",
    "\n",
    "    if var_key not in variables:\n",
    "        raise ValueError(f\"Variable '{var_key}' not found in variables dictionary.\")\n",
    "\n",
    "    var_info = variables[var_key]\n",
    "    var_code = var_info['code']\n",
    "    folder_name = var_info['folder']\n",
    "\n",
    "    for gcm_key, gcm_val in GCM.items():\n",
    "        for rcm_key, rcm_val in RCM.items():\n",
    "            for period_type, period_dict in period_dates.items():\n",
    "                scen = scenario['hist'] if period_type == 'hist' else scenario['RCP']\n",
    "\n",
    "                for label, date_range in period_dict.items():\n",
    "                    file_path = (\n",
    "                        f\"/{location}/{disk}/{folder}/{subfolder}/{gcm_rcm_folder}/Climate_raw_data/{variable_folder}/\"\n",
    "                       f\"{var_code}_EUR-11_{gcm_val}_{scen}_{rNi1p1}_{rcm_val}_{v_number}_{time_resol}_{date_range}.nc\"\n",
    "                    )\n",
    "\n",
    "                    if os.path.exists(file_path):\n",
    "                        files[period_type].append(file_path)\n",
    "                    else:\n",
    "                        print(f\"Missing: {file_path}\")\n",
    "\n",
    "    return files\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "9ca03c7d-b019-4261-88a1-a14fc37deb20",
   "metadata": {},
   "outputs": [],
   "source": [
    "def create_solar_datasets_from_file_dict(file_dict):\n",
    "    return {\n",
    "        \"hist\": xr.open_mfdataset(file_dict[\"hist\"], combine=\"by_coords\", decode_coords=\"all\"),\n",
    "        \"mid\":  xr.open_mfdataset(file_dict[\"mid\"],  combine=\"by_coords\", decode_coords=\"all\"),\n",
    "        \"end\":  xr.open_mfdataset(file_dict[\"end\"],  combine=\"by_coords\", decode_coords=\"all\"),\n",
    "    }\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "e56a0db2-0a88-435f-b25a-428535dd7b08",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19710101-197112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19720101-197212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19730101-197312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19740101-197412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19750101-197512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19760101-197612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19770101-197712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19780101-197812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19790101-197912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19800101-198012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19810101-198112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19820101-198212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19830101-198312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19840101-198412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19850101-198512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19860101-198612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19870101-198712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19880101-198812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19890101-198912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19900101-199012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19910101-199112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19920101-199212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19930101-199312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19940101-199412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19950101-199512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19960101-199612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19970101-199712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19980101-199812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_19990101-199912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_historical_r1i1p1_CNRM-ALADIN63_v2_3hr_20000101-200012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_203601010130-203612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_203701010130-203712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_203801010130-203812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_203901010130-203912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204001010130-204012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204101010130-204112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204201010130-204212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204301010130-204312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204401010130-204412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204501010130-204512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204601010130-204612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204701010130-204712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204801010130-204812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_204901010130-204912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205001010130-205012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205101010130-205112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205201010130-205212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205301010130-205312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205401010130-205412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205501010130-205512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205601010130-205612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205701010130-205712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205801010130-205812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_205901010130-205912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206001010130-206012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206101010130-206112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206201010130-206212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206301010130-206312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206401010130-206412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_206501010130-206512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207101010130-207112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207201010130-207212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207301010130-207312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207401010130-207412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207501010130-207512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207601010130-207612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207701010130-207712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207801010130-207812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_207901010130-207912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208001010130-208012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208101010130-208112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208201010130-208212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208301010130-208312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208401010130-208412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208501010130-208512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208601010130-208612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208701010130-208712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208801010130-208812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_208901010130-208912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209001010130-209012312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209101010130-209112312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209201010130-209212312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209301010130-209312312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209401010130-209412312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209501010130-209512312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209601010130-209612312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209701010130-209712312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209801010130-209812312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_209901010130-209912312230.nc\n",
      "Missing: /Volumes/LaCie 1/Compound_events_study_gihub/Climate_models_data/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Climate_raw_data/Solar/rsds_EUR-11_CNRM-CERFACS-CNRM-CM5_rcp85_r1i1p1_CNRM-ALADIN63_v2_3hr_210001010130-210012312230.nc\n"
     ]
    },
    {
     "ename": "OSError",
     "evalue": "no files to open",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mOSError\u001b[0m                                   Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[20], line 3\u001b[0m\n\u001b[1;32m      1\u001b[0m file_dict \u001b[38;5;241m=\u001b[39m generate_file_paths(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124msolar\u001b[39m\u001b[38;5;124m\"\u001b[39m)  \u001b[38;5;66;03m# or \"solar\", or whatever your variable key is\u001b[39;00m\n\u001b[0;32m----> 3\u001b[0m solar_datasets \u001b[38;5;241m=\u001b[39m create_solar_datasets_from_file_dict(file_dict)\n\u001b[1;32m      5\u001b[0m solar_ds_hist \u001b[38;5;241m=\u001b[39m solar_datasets[\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mhist\u001b[39m\u001b[38;5;124m\"\u001b[39m]\n\u001b[1;32m      6\u001b[0m solar_ds_mid  \u001b[38;5;241m=\u001b[39m solar_datasets[\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmid\u001b[39m\u001b[38;5;124m\"\u001b[39m]\n",
      "Cell \u001b[0;32mIn[18], line 3\u001b[0m, in \u001b[0;36mcreate_solar_datasets_from_file_dict\u001b[0;34m(file_dict)\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m \u001b[38;5;21mcreate_solar_datasets_from_file_dict\u001b[39m(file_dict):\n\u001b[1;32m      2\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m {\n\u001b[0;32m----> 3\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mhist\u001b[39m\u001b[38;5;124m\"\u001b[39m: xr\u001b[38;5;241m.\u001b[39mopen_mfdataset(file_dict[\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mhist\u001b[39m\u001b[38;5;124m\"\u001b[39m], combine\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mby_coords\u001b[39m\u001b[38;5;124m\"\u001b[39m, decode_coords\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mall\u001b[39m\u001b[38;5;124m\"\u001b[39m),\n\u001b[1;32m      4\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmid\u001b[39m\u001b[38;5;124m\"\u001b[39m:  xr\u001b[38;5;241m.\u001b[39mopen_mfdataset(file_dict[\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mmid\u001b[39m\u001b[38;5;124m\"\u001b[39m],  combine\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mby_coords\u001b[39m\u001b[38;5;124m\"\u001b[39m, decode_coords\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mall\u001b[39m\u001b[38;5;124m\"\u001b[39m),\n\u001b[1;32m      5\u001b[0m         \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mend\u001b[39m\u001b[38;5;124m\"\u001b[39m:  xr\u001b[38;5;241m.\u001b[39mopen_mfdataset(file_dict[\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mend\u001b[39m\u001b[38;5;124m\"\u001b[39m],  combine\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mby_coords\u001b[39m\u001b[38;5;124m\"\u001b[39m, decode_coords\u001b[38;5;241m=\u001b[39m\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mall\u001b[39m\u001b[38;5;124m\"\u001b[39m),\n\u001b[1;32m      6\u001b[0m     }\n",
      "File \u001b[0;32m/Applications/anaconda3/lib/python3.12/site-packages/xarray/backends/api.py:1653\u001b[0m, in \u001b[0;36mopen_mfdataset\u001b[0;34m(paths, chunks, concat_dim, compat, preprocess, engine, data_vars, coords, combine, parallel, join, attrs_file, combine_attrs, **kwargs)\u001b[0m\n\u001b[1;32m   1650\u001b[0m paths \u001b[38;5;241m=\u001b[39m _find_absolute_paths(paths, engine\u001b[38;5;241m=\u001b[39mengine, \u001b[38;5;241m*\u001b[39m\u001b[38;5;241m*\u001b[39mkwargs)\n\u001b[1;32m   1652\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m paths:\n\u001b[0;32m-> 1653\u001b[0m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mOSError\u001b[39;00m(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mno files to open\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m   1655\u001b[0m paths1d: \u001b[38;5;28mlist\u001b[39m[\u001b[38;5;28mstr\u001b[39m \u001b[38;5;241m|\u001b[39m ReadBuffer]\n\u001b[1;32m   1656\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m combine \u001b[38;5;241m==\u001b[39m \u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mnested\u001b[39m\u001b[38;5;124m\"\u001b[39m:\n",
      "\u001b[0;31mOSError\u001b[0m: no files to open"
     ]
    }
   ],
   "source": [
    "file_dict = generate_file_paths(\"solar\")  # or \"solar\", or whatever your variable key is\n",
    "\n",
    "solar_datasets = create_solar_datasets_from_file_dict(file_dict)\n",
    "\n",
    "solar_ds_hist = solar_datasets[\"hist\"]\n",
    "solar_ds_mid  = solar_datasets[\"mid\"]\n",
    "solar_ds_end  = solar_datasets[\"end\"]\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "7ec3e4ea-f54a-4ca5-af20-4caaf348add1",
   "metadata": {
    "scrolled": true
   },
   "outputs": [],
   "source": [
    "solar_datasets = {\n",
    "    'hist': xr.open_mfdataset(file_dict['hist'], chunks={'time': 100}),\n",
    "    'mid':  xr.open_mfdataset(file_dict['mid'], chunks={'time': 100}),\n",
    "    'end':  xr.open_mfdataset(file_dict['end'], chunks={'time': 100}),\n",
    "}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "d15c1b03-83a9-4780-8791-6d4752e572cb",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Path to folder of shapefiles\n",
    "geo_data_path = f\"/{location}/{disk}/Geospatial_data\"\n",
    "\n",
    "#Enter the folder path to the shapefiles of Norway and for regions\n",
    "norway_shp_folder = f'{geo_data_path}/Norway_E_maps.qgz'\n",
    "elspot_regions_folder = f'{geo_data_path}/Elspot_regions_PostProcessed'\n",
    "\n",
    "#Define your geographical coordinates system\n",
    "crs_name = \"EPSG:4326\"\n",
    "\n",
    "#PROJECTION ROTATED POLE\n",
    "scale=0.5\n",
    "\n",
    "#bboxes available on bbox finder to determine the square area of your regions\n",
    "bbox_no  = [4.096012, 57.736234, 32.177067, 71.599506] # For all Norway (bounding box)\n",
    "bbox_er1 = [6.833496, 58.688359, 13.908691, 62.885205] #bbox for NO1 region\n",
    "bbox_er2 = [4.514952, 57.705340, 12.952452, 60.963527] #bbox for NO2 region\n",
    "bbox_er3 = [1.593189, 58.712348, 17.149830, 65.848681] #bbox for NO3 region\n",
    "bbox_er4 = [7.646484, 63.918058, 32.167969, 71.635993] #bbox for NO4 region\n",
    "bbox_er5 = [-1.113567, 56.213244, 14.443073, 63.874893] #bbox for NO5 region\n",
    "\n",
    "#TRansformation of the crs to a more usual one \n",
    "original_crs = ccrs.RotatedPole(pole_latitude=39.25, pole_longitude=-162)\n",
    "transformer = pyproj.Transformer.from_crs(crs_name, original_crs)\n",
    "\n",
    "# New bbox coordinates matching EURO-CORDEX projection.\n",
    "RLON_MIN, RLAT_MIN = transformer.transform(bbox_no[1], bbox_no[0])\n",
    "RLON_MAX, RLAT_MAX = transformer.transform(bbox_no[3], bbox_no[2]) "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "adefcc95-4522-48d4-a2cc-d596e213844e",
   "metadata": {},
   "outputs": [],
   "source": [
    "#Enter the file path to your shapefiles\n",
    "shapefiles = {\n",
    "    'Norway': f'{geo_data_path}/Norway_E_maps.qgz/gadm41_NOR_1.shp', \n",
    "    'NO1': f'{geo_data_path}/Elspot_regions_PostProcessed/NO1_Land_Availability.shp', \n",
    "    'NO2': f'{geo_data_path}/Elspot_regions_PostProcessed/NO2_Land_Availability.shp', \n",
    "    'NO3': f'{geo_data_path}/Elspot_regions_PostProcessed/NO3_Land_Availability.shp', \n",
    "    'NO4': f'{geo_data_path}/Elspot_regions_PostProcessed/NO4_Land_Availability.shp', \n",
    "    'NO5': f'{geo_data_path}/Elspot_regions_PostProcessed/NO5_Land_Availability.shp'\n",
    "}\n",
    "\n",
    "bounding_boxes = {\n",
    "    'NO': bbox_no, \n",
    "    'NO1': bbox_er1, \n",
    "    'NO2': bbox_er2, \n",
    "    'NO3': bbox_er3,\n",
    "    'NO4': bbox_er4, \n",
    "    'NO5': bbox_er5\n",
    "}"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "9803cf79-2d0a-4e84-b0a4-3bb86f64cfe9",
   "metadata": {},
   "outputs": [],
   "source": [
    "shapes = {}\n",
    "for name, path in shapefiles.items():\n",
    "    gdf = gpd.read_file(path)\n",
    "    gdf = gdf.to_crs(crs_name)\n",
    "    shapes[name] = gdf\n",
    "\n",
    "for name, ds in solar_datasets.items():\n",
    "    solar_datasets[name] = ds.rio.write_crs(crs_name)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "f309450e-f19f-48ee-b915-7ff728ad2919",
   "metadata": {},
   "outputs": [],
   "source": [
    "def clip_dataset_with_bbox(ds, region_name, bounding_boxes):\n",
    "    bbox = bounding_boxes[region_name]\n",
    "\n",
    "    coords = ds.coords.keys()\n",
    "\n",
    "    if 'rlat' in coords and 'rlon' in coords:\n",
    "        # rotated pole coordinates - use .sel()\n",
    "        print(f\"→ Clipping using rotated coordinates (rlat/rlon) for region: {region_name}\")\n",
    "        RLON_MIN, RLAT_MIN = transformer.transform(bbox[1], bbox[0])  # lat, lon order!\n",
    "        RLON_MAX, RLAT_MAX = transformer.transform(bbox[3], bbox[2])\n",
    "        ds_sliced = ds.sel(rlat=slice(RLAT_MIN, RLAT_MAX), rlon=slice(RLON_MIN, RLON_MAX))\n",
    "        return ds_sliced\n",
    "\n",
    "    elif 'x' in coords and 'y' in coords:\n",
    "        # lat/lon are variables, not coordinates -> mask using .where()\n",
    "        print(f\"→ Clipping using lat/lon data variables mask for region: {region_name}\")\n",
    "\n",
    "        lon = ds['lon']\n",
    "        lat = ds['lat']\n",
    "\n",
    "        mask = (\n",
    "            (lon >= bbox[0]) & (lon <= bbox[2]) &\n",
    "            (lat >= bbox[1]) & (lat <= bbox[3])\n",
    "        )\n",
    "\n",
    "        if hasattr(mask, 'compute'):\n",
    "            mask = mask.compute()\n",
    "\n",
    "        if mask.sum().values == 0:\n",
    "            print(f\"✗ No data points selected for region {region_name}\")\n",
    "            return None\n",
    "\n",
    "        ds_sliced = ds.where(mask, drop=True)\n",
    "        return ds_sliced\n",
    "\n",
    "    else:\n",
    "        print(f\"✗ Dataset does not have known spatial coords for region {region_name}\")\n",
    "        return None\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "efbb88e6-3a30-4082-ae28-0fc01371e3bc",
   "metadata": {
    "collapsed": true,
    "jupyter": {
     "outputs_hidden": true
    },
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "=== Period: hist ===\n",
      "→ Clipping using lat/lon data variables mask for region: NO\n",
      "✓ Sliced hist for NO - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 139, 'x': 133, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO1\n",
      "✓ Sliced hist for NO1 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 38, 'x': 33, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO2\n",
      "✓ Sliced hist for NO2 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 30, 'x': 40, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO3\n",
      "✓ Sliced hist for NO3 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 67, 'x': 73, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO4\n",
      "✓ Sliced hist for NO4 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 83, 'x': 98, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO5\n",
      "✓ Sliced hist for NO5 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 73, 'x': 77, 'nvertex': 4})\n",
      "\n",
      "=== Period: mid ===\n",
      "→ Clipping using lat/lon data variables mask for region: NO\n",
      "✓ Sliced mid for NO - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 139, 'x': 133, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO1\n",
      "✓ Sliced mid for NO1 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 38, 'x': 33, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO2\n",
      "✓ Sliced mid for NO2 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 30, 'x': 40, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO3\n",
      "✓ Sliced mid for NO3 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 67, 'x': 73, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO4\n",
      "✓ Sliced mid for NO4 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 83, 'x': 98, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO5\n",
      "✓ Sliced mid for NO5 - dims: FrozenMappingWarningOnValuesAccess({'time': 87664, 'axis_nbounds': 2, 'y': 73, 'x': 77, 'nvertex': 4})\n",
      "\n",
      "=== Period: end ===\n",
      "→ Clipping using lat/lon data variables mask for region: NO\n",
      "✓ Sliced end for NO - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 139, 'x': 133, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO1\n",
      "✓ Sliced end for NO1 - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 38, 'x': 33, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO2\n",
      "✓ Sliced end for NO2 - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 30, 'x': 40, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO3\n",
      "✓ Sliced end for NO3 - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 67, 'x': 73, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO4\n",
      "✓ Sliced end for NO4 - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 83, 'x': 98, 'nvertex': 4})\n",
      "→ Clipping using lat/lon data variables mask for region: NO5\n",
      "✓ Sliced end for NO5 - dims: FrozenMappingWarningOnValuesAccess({'time': 87656, 'axis_nbounds': 2, 'y': 73, 'x': 77, 'nvertex': 4})\n"
     ]
    }
   ],
   "source": [
    "sliced_by_region = {}\n",
    "\n",
    "for period, ds in solar_datasets.items():\n",
    "    print(f\"\\n=== Period: {period} ===\")\n",
    "    sliced_by_region[period] = {}\n",
    "    for region in bounding_boxes:\n",
    "        sliced = clip_dataset_with_bbox(ds, region, bounding_boxes)\n",
    "        if sliced is not None:\n",
    "            sliced_by_region[period][region] = sliced\n",
    "            print(f\"✓ Sliced {period} for {region} - dims: {sliced.dims}\")\n",
    "        else:\n",
    "            print(f\"✗ Failed to slice {period} for {region}\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 49,
   "id": "e9922db4-3e93-49cd-a2f0-074a6e8c1257",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Processing hist...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Applications/anaconda3/lib/python3.12/site-packages/regionmask/core/mask.py:406: UserWarning: Detected overlapping regions. As of v0.11.0 these are correctly taken into account. Note, however, that a different mask is returned than with older versions of regionmask. To suppress this warning, set `overlap=True` (to restore the old, incorrect, behaviour, set `overlap=False`).\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Saved: /Volumes/LaCie 1/Compound_events/Results/CSVs/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Solar_3hrs/regional_mean_rsds_hist.csv\n",
      "Processing mid...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Applications/anaconda3/lib/python3.12/site-packages/regionmask/core/mask.py:406: UserWarning: Detected overlapping regions. As of v0.11.0 these are correctly taken into account. Note, however, that a different mask is returned than with older versions of regionmask. To suppress this warning, set `overlap=True` (to restore the old, incorrect, behaviour, set `overlap=False`).\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Saved: /Volumes/LaCie 1/Compound_events/Results/CSVs/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Solar_3hrs/regional_mean_rsds_mid.csv\n",
      "Processing end...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/Applications/anaconda3/lib/python3.12/site-packages/regionmask/core/mask.py:406: UserWarning: Detected overlapping regions. As of v0.11.0 these are correctly taken into account. Note, however, that a different mask is returned than with older versions of regionmask. To suppress this warning, set `overlap=True` (to restore the old, incorrect, behaviour, set `overlap=False`).\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Saved: /Volumes/LaCie 1/Compound_events/Results/CSVs/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Solar_3hrs/regional_mean_rsds_end.csv\n"
     ]
    }
   ],
   "source": [
    "def compute_regional_means(ds, shapes):\n",
    "    \"\"\"\n",
    "    Compute regional mean time series for overlapping regions using a 3D mask.\n",
    "    Returns a DataFrame with time as index and regions as columns.\n",
    "    \"\"\"\n",
    "    import regionmask\n",
    "\n",
    "    # Create regionmask.Regions object\n",
    "    regions = regionmask.Regions([gdf.geometry.values[0] for gdf in shapes.values()],\n",
    "                                 names=list(shapes.keys()))\n",
    "\n",
    "    # Create a 3D mask (region × y × x)\n",
    "    mask_3d = regions.mask_3D(ds)\n",
    "\n",
    "    df = pd.DataFrame(index=pd.to_datetime(ds.time.values))\n",
    "\n",
    "    # Iterate over regions and compute mean\n",
    "    for i, name in enumerate(shapes.keys()):\n",
    "        region_mask = mask_3d.isel(region=i)\n",
    "        masked_data = ds.rsds.where(region_mask)\n",
    "        regional_mean = masked_data.mean(dim=(\"y\", \"x\"), skipna=True)\n",
    "        df[name] = regional_mean.compute().values\n",
    "\n",
    "    return df\n",
    "\n",
    "# ===== Run and save CSVs =====\n",
    "output_dir = \"/Volumes/LaCie 1/Compound_events/Results/CSVs/CNRM_CERFACS_CNRM_CM5_CNRM_ALADIN63/Solar_3hrs/\"\n",
    "os.makedirs(output_dir, exist_ok=True)\n",
    "\n",
    "for period, ds in solar_datasets.items():\n",
    "    print(f\"Processing {period}...\")\n",
    "    df = compute_regional_means(ds, shapes)\n",
    "    output_path = os.path.join(output_dir, f\"regional_mean_rsds_{period}.csv\")\n",
    "    df.to_csv(output_path)\n",
    "    print(f\"Saved: {output_path}\")\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base]",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
